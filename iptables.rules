#!/bin/bash
# chkconfig: 345 99 01
# description: Applies iptable rules on startup

### BEGIN INIT INFO
# Provides: iptables.rules
# Required-Start: iptables network
# Defalt-Start: 3 4 5
# Default-Stop: 0 1 6
# Description: Iptables rules
### END INIT INFO

#########
### Ports
# Input TCP
# 22922 (ssh)
INTCP=(22922)

# Input UDP
# 53 (dns)
INUDP=(53)

# Output TCP
# 22 (ssh), 22922 (ssh), 80 (http)
# 443 (https), 465 (smtps), 993 (imaps) 
OUTTCP=(22 22922 80 443 465 993 8443)    #Output TCP

# Output UDP
# 53 (dns)
OUTUDP=(53)                 #Output UDP

#########
### Hosts
HOSTS=( 129.21.0.0/16 74.70.0.0/16 162.244.0.0/16 162.248.0.0/16 168.235.0.0/16 )


###############
### Flush rules
echo "Flushing rules"
iptables -F
iptables -F -t nat

############################
### Default policies -> DROP
echo "Default policies -> drop"
for p in INPUT FORWARD OUTPUT
do
    iptables -P $p DROP
done

#######################
### Accept all loopback
echo "Loopback rules -> accept"
iptables -A INPUT -i lo -m comment --comment "Loopback" -j ACCEPT
iptables -A OUTPUT -o lo -m comment --comment "Loopback" -j ACCEPT

########################################
### Allow ping out, block all other icmp
echo "Icmp rules -> accept outbound, deny all else"
iptables -A OUTPUT -p icmp --icmp-type 8 -m comment --comment "Allow ping requests output" -j ACCEPT
iptables -A INPUT -p icmp --icmp-type 0 -m comment --comment "Allow ping reply input" -j ACCEPT
iptables -A OUTPUT -p icmp -m comment --comment "Drop other ICMP output" -j DROP
iptables -A INPUT -p icmp -m comment --comment "Drop other ICMP input" -j DROP

#####################
### Accept tcp inputs
echo "Input tcp rules -> accept ssh"
for h in $HOSTS
do
    for p in $INTCP
    do
        iptables -A INPUT -s $h -p tcp --dport $p -m state --state NEW,ESTABLISHED -j ACCEPT
    done
done

#####################
### Accept udp inputs
echo "Input udp rules -> accept dns"
for h in $HOSTS
do
    for p in $INUDP
    do
        iptables -A INPUT -s $h -p udp --dport $p -m state --state NEW,ESTABLISHED -j ACCEPT
    done
done

#####################
### Accept tcp output
echo "Output tcp rules -> accept ssh, http, https"
for p in $OUTTCP
do
    iptables -A OUTPUT -p tcp --dport $p -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
done

#####################
### Accept udp output
echo "Output udp rules -> accept dns"
for p in $OUTUDP
do
    iptables -A OUTPUT -p udp --dport $p -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
done

########################################################
### Drop any outside attempts to connect, accept replies
#echo "Default -> Accept established/related, drop new/invalid"
#iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

###################
### Print new rules
iptables -nL

#!/bin/bash
# chkconfig: 345 99 01
# description: Applies iptable rules on startup

### BEGIN INIT INFO
# Provides: iptables.rules
# Required-Start: iptables network
# Defalt-Start: 3 4 5
# Default-Stop: 0 1 6
# Description: Iptables rules
### END INIT INFO

#########
### Hosts
HOSTS=( 129.21.0.0/16 74.70.0.0/16 162.244.0.0/16 162.248.0.0/16 168.235.0.0/16 )

#########
### Rate Limit Input

#########
### Ports
# Input TCP - FILTERED BY HOSTS
# 22922 (ssh)
INTCPFILTERED=( 22922 )

# Input TCP - NOT FILTERED BY HOSTS
INTCP=( 56298 )

# Input UDP - FILTERED BY HOSTS
INUDPFILTERED=(  )

INUDP=( 56298 )

# Output TCP
# 22 (ssh), 22922 (ssh), 80 (http)
# 443 (https), 465 (smtps), 993 (imaps) 
OUTTCP=( 22 22922 80 443 465 993 8443 53 5000 6797 6544 )    #Output TCP

# Output UDP
OUTUDP=( 53 1337 80 443 6544 )                 #Output UDP

###############
### Flush rules
echo "Flushing rules"
iptables -F
iptables -F -t nat

############################
### Default policies -> DROP
echo "Default policies -> accept"
for p in INPUT FORWARD OUTPUT
do
    iptables -P $p ACCEPT
done

#######################
### Accept all loopback
echo "Loopback rules -> accept"
iptables -A INPUT -i lo -m comment --comment "Loopback" -j ACCEPT
iptables -A OUTPUT -o lo -m comment --comment "Loopback" -j ACCEPT

########################################
### Allow ping out, block all other icmp
echo "Icmp rules -> accept outbound, deny all else"
iptables -A OUTPUT -p icmp --icmp-type 8 -m comment --comment "Allow ping requests output" -j ACCEPT
iptables -A INPUT -p icmp --icmp-type 0 -m comment --comment "Allow ping reply input" -j ACCEPT
iptables -A OUTPUT -p icmp -m comment --comment "Drop other ICMP output" -j DROP
iptables -A INPUT -p icmp -m comment --comment "Drop other ICMP input" -j DROP

####################
### Accept DNS
iptables -A INPUT -p udp --sport 53 -j ACCEPT
iptables -A INPUT -p tcp --sport 53 -j ACCEPT

#####################
### Accept tcp inputs
### filtered by HOSTS
for h in ${HOSTS[@]};
do
    for p in ${INTCPFILTERED[@]}
    do
        echo "Input tcp rules -> accept $p from $h"
        iptables -A INPUT -s $h -p tcp --sport $p -j ACCEPT
    done
done

#########################
### Accept tcp inputs
### NOT FILTERED by HOSTS
for p in ${INTCP[@]}
do
    echo "Input tcp rules -> accept $p from ALL"
    iptables -A INPUT -p tcp --sport $p -j ACCEPT
done

#####################
### Accept udp inputs
for h in ${HOSTS[@]};
do
    for p in ${INUDPFILTERED[@]}
    do
        echo "Input udp rules -> accept $p from $h"
        iptables -A INPUT -s $h -p udp --sport $p -j ACCEPT
    done
done

#########################
### Accept udp inputs
### NOT FILTERED by HOSTS
for p in ${INUDP[@]}
do
    echo "Input udp rules -> accept $p from ALL"
    iptables -A INPUT -p udp --sport $p -j ACCEPT
done

#####################
### Accept tcp output
for p in ${OUTTCP[@]};
do
    echo "Output tcp rule -> accept $p"
    iptables -A OUTPUT -p tcp --dport $p -j ACCEPT
done

#####################
### Accept udp output
for p in ${OUTUDP[@]};
do
    echo "Output udp rule -> accept $p"
    iptables -A OUTPUT -p udp --dport $p -j ACCEPT
done

iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

############################
### LAST RULE -> DROP
echo "LAST RULE -> DROP"
for p in INPUT FORWARD OUTPUT
do
    iptables -A $p -j DROP
done

###################
### Print new rules
iptables -nL
